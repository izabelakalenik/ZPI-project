name: CI
on:
  pull_request:
    branches:
      - main

jobs:
  flutter_test:
    name: Run flutter test and analyze
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-java@v1
        with:
          java-version: "17.x"
      - uses: subosito/flutter-action@v1
        with:
          channel: "stable"
      - run: flutter pub get
      - run: flutter analyze
      - run: flutter test

  build_ios:
    name: Build Flutter (iOS)
    needs: [flutter_test]
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-java@v1
        with:
          java-version: "12.x"
      - uses: subosito/flutter-action@v1
        with:
          channel: "stable"
      - name: Install dependencies
        run: flutter pub get
      - run: flutter clean
      - name: Build iOS
        run: flutter build ios --no-codesign

  build_apk:
    name: Build Flutter (APK)
    needs: [ flutter_test ]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      - name: Install dependencies
        run: flutter pub get
      - run: flutter clean
      - name: Build apk
        run: flutter build apk

  build_appbundle:
    name: Build Flutter (APK)
#    needs: [ flutter_test ]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      - name: Install dependencies
        run: flutter pub get
      - run: flutter clean
      - name: Build app bundle
        run: flutter build appbundle

# error:
#  Running Gradle task 'bundleRelease'...
#
#FAILURE: Build failed with an exception.
#
#  * Where:
#Build file '/home/runner/work/ZPI-project/ZPI-project/android/app/build.gradle' line: 2
#
#  * What went wrong:
#An exception occurred applying plugin request [id: 'com.android.application']
#  > Failed to apply plugin 'com.android.internal.application'.
#  > Android Gradle plugin requires Java 17 to run. You are currently using Java 12.
#     Your current JDK is located in /opt/hostedtoolcache/jdk/12.0.2/x64
#     You can try some of the following options:
#      - changing the IDE settings.
#      - changing the JAVA_HOME environment variable.
#      - changing `org.gradle.java.home` in `gradle.properties`.
#
#  * Try:
#  > Run with --stacktrace option to get the stack trace.
#  > Run with --info or --debug option to get more log output.
#  > Run with --scan to get full insights.
#  > Get more help at https://help.gradle.org.
#
#  BUILD FAILED in 1m 41s
#  Running Gradle task 'bundleRelease'...                            102.5s
#  Gradle task bundleRelease failed with exit code 1

#  build_appbundle:
#    name: Build Flutter (Android)
#    needs: [ flutter_test ]
#    runs-on: ubuntu-latest
#    steps:
#      - uses: actions/checkout@v2
#      - uses: actions/setup-java@v1
#        with:
#          java-version: "12.x"
#      - uses: subosito/flutter-action@v1
#        with:
#          channel: "stable"
#      - run: flutter pub get
#      - run: flutter clean
#      - run: flutter build appbundle